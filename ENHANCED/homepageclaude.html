<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BitStorm — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&family=Playfair+Display:wght@400;500&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --blue-900: #0c2340;
  --blue-800: #123a6b;
  --blue-700: #174f96;
  --blue-600: #1a5fa8;
  --blue-400: #3b8fd4;
  --blue-200: #b8d8f5;
  --blue-100: #dceefb;
  --blue-50:  #f0f7fd;
  --white:    #ffffff;
  --text-primary: #0d1f35;
  --text-secondary: #4a6785;
  --text-muted: #8aabca;
  --border: #d0e4f4;
  --sidebar-w: 240px;
  --nav-h: 64px;
}

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--blue-50);
  color: var(--text-primary);
  display: flex;
  min-height: 100vh;
}

/* ── Sidebar ── */
.sidebar {
  width: var(--sidebar-w);
  flex-shrink: 0;
  background: var(--blue-800);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0;
  height: 100vh;
  z-index: 100;
  overflow: hidden;
}

.sidebar::before {
  content: '';
  position: absolute;
  width: 300px; height: 300px;
  border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.04);
  bottom: -80px; right: -120px;
  pointer-events: none;
}

.sidebar-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 28px 24px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  flex-shrink: 0;
}



.brand-icon svg { width: 50px; height: 60px; stroke: var(--white); }
.brand-name { font-size: 20px; font-weight: 600; color: var(--white); letter-spacing: 0.02em; }

.sidebar-nav {
  flex: 1;
  padding: 20px 14px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  overflow-y: auto;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 9px;
  cursor: pointer;
  transition: background 0.15s;
  color: rgba(255,255,255,0.5);
  font-size: 13.5px;
  font-weight: 400;
  text-decoration: none;
  border: none; background: none; width: 100%; text-align: left;
}

.nav-item svg { width: 16px; height: 16px; stroke: currentColor; flex-shrink: 0; }
.nav-item:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.8); }
.nav-item.active { background: rgba(255,255,255,0.12); color: var(--white); font-weight: 500; }

.nav-section-label {
  font-size: 10px;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.25);
  padding: 14px 12px 6px;
  font-weight: 500;
}

.sidebar-footer {
  padding: 16px 14px;
  border-top: 1px solid rgba(255,255,255,0.07);
}

.connect-btn {
  width: 100%;
  padding: 10px 12px;
  border-radius: 9px;
  border: 1px solid rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.07);
  color: var(--white);
  font-size: 13px; font-weight: 500;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer;
  display: flex; align-items: center; gap: 8px;
  transition: background 0.2s, border-color 0.2s;
}

.connect-btn svg { width: 15px; height: 15px; stroke: var(--blue-200); }
.connect-btn:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.25); }
.connect-btn.connected { border-color: rgba(184,216,245,0.4); color: var(--blue-200); }

.conn-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--text-muted); margin-left: auto; flex-shrink: 0;
  transition: background 0.3s;
}
.connect-btn.connected .conn-dot { background: #4ade80; }

/* ── Main ── */
.main {
  margin-left: var(--sidebar-w);
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* Top bar */
.topbar {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  height: var(--nav-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0; z-index: 50;
}

.topbar-left h1 {
  font-size: 17px; font-weight: 600;
  color: var(--text-primary); letter-spacing: -0.01em;
}

.topbar-left p {
  font-size: 12px; color: var(--text-muted); font-weight: 300;
}

.topbar-right {
  display: flex; align-items: center; gap: 14px;
}

.alert-banner {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  font-size: 12.5px;
  font-weight: 500;
  color: #b91c1c;
  animation: pulseAlert 2s ease-in-out infinite;
}

.alert-banner svg { width: 14px; height: 14px; stroke: #b91c1c; }
.alert-banner.visible { display: flex; }

@keyframes pulseAlert {
  0%,100% { opacity: 1; } 50% { opacity: 0.7; }
}

.time-badge {
  font-size: 12px;
  color: var(--text-secondary);
  background: var(--blue-50);
  border: 1px solid var(--border);
  padding: 5px 12px;
  border-radius: 20px;
  font-weight: 400;
}

/* Content */
.content {
  padding: 28px 32px 40px;
  flex: 1;
}

/* Greeting */
.greeting {
  margin-bottom: 28px;
  animation: fadeUp 0.6s ease both;
}

.greeting h2 {
  font-size: 22px; font-weight: 600;
  color: var(--text-primary); letter-spacing: -0.02em;
}

.greeting h2 span { color: var(--blue-600); }
.greeting p { font-size: 13.5px; color: var(--text-secondary); margin-top: 3px; font-weight: 300; }

/* Section header */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px; margin-top: 32px;
}

.section-header:first-of-type { margin-top: 0; }

.section-title {
  font-size: 13px; font-weight: 600;
  color: var(--text-primary); letter-spacing: -0.01em;
  display: flex; align-items: center; gap: 8px;
}

.section-title svg { width: 15px; height: 15px; stroke: var(--blue-400); }

.ref-tag {
  font-size: 10.5px;
  color: var(--text-muted);
  font-weight: 300;
  font-style: italic;
}

/* Metric row */
.metric-row {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 16px;
  margin-bottom: 12px;
  animation: fadeUp 0.5s ease both;
}

/* Cards */
.card {
  background: var(--white);
  border-radius: 14px;
  border: 1px solid var(--border);
  padding: 22px 24px;
  position: relative;
  overflow: hidden;
}

.metric-card {
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 6px;
}

.metric-label {
  font-size: 11px; font-weight: 500;
  text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--text-muted);
}

.metric-value {
  font-size: 52px; font-weight: 600;
  color: var(--blue-800);
  line-height: 1;
  letter-spacing: -0.03em;
  font-variant-numeric: tabular-nums;
}

.metric-unit {
  font-size: 13px; color: var(--text-secondary); font-weight: 400;
}

.metric-status {
  font-size: 11.5px; font-weight: 500;
  padding: 3px 9px; border-radius: 20px;
  display: inline-flex; align-items: center; gap: 5px;
  width: fit-content; margin-top: 4px;
}

.metric-status.normal { background: #f0fdf4; color: #15803d; }
.metric-status.warning { background: #fff7ed; color: #c2410c; }
.metric-status.dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; display: inline-block; }

.chart-card {
  padding: 18px 20px 14px;
}

.chart-label {
  font-size: 11px; font-weight: 500; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.08em;
  margin-bottom: 10px;
}

canvas {
  width: 100% !important;
  display: block;
}

/* Stat boxes */
.stat-boxes {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 6px;
  animation: fadeUp 0.5s ease 0.1s both;
}

.stat-box {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 20px;
  text-align: center;
}

.stat-box .stat-val {
  font-size: 22px; font-weight: 600;
  color: var(--blue-700); letter-spacing: -0.02em;
}

.stat-box .stat-key {
  font-size: 11px; color: var(--text-muted);
  font-weight: 400; margin-top: 3px;
}

/* Quote */
.quote-strip {
  background: var(--blue-50);
  border-left: 3px solid var(--blue-200);
  border-radius: 0 10px 10px 0;
  padding: 12px 18px;
  margin: 6px 0 0;
  animation: fadeUp 0.5s ease 0.15s both;
}

.quote-strip p {
  font-size: 12.5px; color: var(--text-secondary);
  font-style: italic; line-height: 1.6; font-weight: 300;
}

.quote-strip cite {
  font-size: 11px; color: var(--text-muted);
  font-style: normal; font-weight: 500;
  display: block; margin-top: 4px;
}

/* Section divider */
.section-divider {
  height: 1px; background: var(--border);
  margin: 28px 0;
}

/* Instructions card */
.instructions-card {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 28px;
  animation: fadeUp 0.5s ease 0.05s both;
}

.instr-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 22px 24px;
}

.instr-card h4 {
  font-size: 13.5px; font-weight: 600;
  color: var(--text-primary); margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}

.instr-card h4 svg { width: 15px; height: 15px; stroke: var(--blue-400); }

.instr-card ol {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.instr-card ol li {
  display: flex; align-items: flex-start; gap: 10px;
  font-size: 13px; color: var(--text-secondary); line-height: 1.5;
}

.step-num {
  width: 20px; height: 20px; flex-shrink: 0;
  border-radius: 50%;
  border: 1px solid var(--blue-200);
  color: var(--blue-400);
  font-size: 10px; font-weight: 600;
  display: flex; align-items: center; justify-content: center;
  margin-top: 1px;
}

/* Fade up animation */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 960px) {
  .sidebar { display: none; }
  .main { margin-left: 0; }
  .metric-row { grid-template-columns: 1fr; }
  .instructions-card { grid-template-columns: 1fr; }
  .stat-boxes { grid-template-columns: repeat(3,1fr); }
  .content { padding: 20px 16px 32px; }
  .topbar { padding: 0 16px; }
}

@media (max-width: 540px) {
  .stat-boxes { grid-template-columns: repeat(3,1fr); gap: 8px; }
  .stat-box .stat-val { font-size: 18px; }
}
</style>
</head>

<body>

<!-- ── Sidebar ── -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <div class="brand-icon">
     <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#03070d;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#3689d7;stop-opacity:1" />
    </linearGradient>
  </defs>
  
  <path d="M100 170 C 100 170 30 120 30 75 A 35 35 0 0 1 100 50 A 35 35 0 0 1 170 75 C 170 120 100 170 100 170 Z" 
        fill="none" 
        stroke="url(#heartGradient)" 
        stroke-width="20" 
        stroke-linejoin="round"/>
        
  <path d="M20 100 H 60 L 75 70 L 95 130 L 115 40 L 135 100 H 180" 
        fill="none" 
        stroke="#63b3ed" 
        stroke-width="10" 
        stroke-linecap="round" 
        stroke-linejoin="round"/>
</svg>
    </div>
    <span class="brand-name">BitStorm</span>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section-label">Monitor</div>
    <button class="nav-item active" onclick="showhome()">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
        <rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
      </svg>
      Dashboard
    </button>
    <button class="nav-item" onclick="showhistory()">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      Health History
    </button>

    <div class="nav-section-label">Account</div>
    <button class="nav-item" onclick="showprofile()">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
      </svg>
       Profile
    </button>
  </nav>

  <div class="sidebar-footer">
    <button class="connect-btn" id="connectBtn" onclick="connectDevice()">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2a10 10 0 0 1 10 10"/><path d="M12 6a6 6 0 0 1 6 6"/><path d="M12 10a2 2 0 0 1 2 2"/>
        <circle cx="4.5" cy="18.5" r="2.5"/>
      </svg>
      Connect Device
      <span class="conn-dot"></span>
    </button>
  </div>
</aside>

<!-- ── Main ── -->
<div class="main">

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-left">
      <h1>Health Dashboard</h1>
      <p>Real-time health monitoring</p>
    </div>
    <div class="topbar-right">
      <div class="alert-banner" id="alertBox">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        Abnormal Reading Detected
      </div>
      <div class="time-badge" id="clockBadge">--:-- --</div>
    </div>
  </header>

  <!-- Content -->
  <main class="content">

    <div class="greeting">
      <h2>Good <span id="greetTime">morning</span>, <span id="userName">there</span> </h2>
      <p>Here's a snapshot of your today's health.</p>
    </div>

    <!-- Device instructions -->
    <div class="instructions-card">
      <div class="instr-card">
        <h4>
          <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          Wearing Instructions
        </h4>
        <ol>
          <li><span class="step-num">1</span> Clip the PPG strip gently to your earlobe.</li>
          <li><span class="step-num">2</span> Ensure proper, clean skin contact.</li>
          <li><span class="step-num">3</span> Avoid movement during measurement.</li>
        </ol>
      </div>
      <div class="instr-card">
        <h4>
          <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2a10 10 0 0 1 10 10"/><path d="M12 6a6 6 0 0 1 6 6"/><path d="M12 10a2 2 0 0 1 2 2"/><circle cx="4.5" cy="18.5" r="2.5"/>
          </svg>
          Connecting Your Device
        </h4>
        <ol>
          <li><span class="step-num">1</span> Click "Connect Device" in the sidebar.</li>
          <li><span class="step-num">2</span> Allow Bluetooth access when prompted.</li>
          <li><span class="step-num">3</span> Select your BitStorm device from the list.</li>
        </ol>
      </div>
    </div>

    <!-- ── Heart Rate ── -->
    <div class="section-header">
      <div class="section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
        Heart Rate
      </div>
    </div>

    <div class="metric-row">
      <div class="card metric-card">
        <div class="metric-label">Current BPM</div>
        <div class="metric-value" id="heartRate">--</div>
        <div class="metric-unit">beats per minute</div>
        <div class="metric-status normal" id="hrStatus">
          <span class="dot"></span> Awaiting data
        </div>
      </div>
      <div class="card chart-card">
        <div class="chart-label">Live waveform</div>
        <canvas id="heartChart" height="140"></canvas>
      </div>
    </div>

    <div class="stat-boxes">
      <div class="stat-box"><div class="stat-val">100</div><div class="stat-key">Max BPM</div></div>
      <div class="stat-box"><div class="stat-val">75</div><div class="stat-key">Average BPM</div></div>
      <div class="stat-box"><div class="stat-val">60</div><div class="stat-key">Min BPM</div></div>
    </div>

    <div class="quote-strip">
      <p>"Your pulse, both at rest and during exercise, can reveal your risk for heart attack and your aerobic capacity."</p>
      <cite>— Harvard Health Publishing</cite>
    </div>

    <div class="section-divider"></div>

    <!-- ── HRV ── -->
    <div class="section-header">
      <div class="section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        Heart Rate Variability (HRV)
      </div>
    </div>

    <div class="metric-row">
      <div class="card metric-card">
        <div class="metric-label">RMSSD</div>
        <div class="metric-value" id="hrv">--</div>
        <div class="metric-unit">milliseconds</div>
        <div class="metric-status normal" id="hrvStatus">
          <span class="dot"></span> Awaiting data
        </div>
      </div>
      <div class="card chart-card">
        <div class="chart-label">Variability waveform</div>
        <canvas id="hrvChart" height="140"></canvas>
      </div>
    </div>

    <div class="stat-boxes">
      <div class="stat-box"><div class="stat-val"> 50-100 ms</div><div class="stat-key">Good HRV</div></div>
      <div class="stat-box"><div class="stat-val">30–50 ms</div><div class="stat-key">Moderate HRV</div></div>
      <div class="stat-box"><div class="stat-val">&lt; 30 ms</div><div class="stat-key">Low HRV</div></div>
    </div>

    <div class="quote-strip">
      <p>"Higher HRV generally indicates better cardiovascular fitness and resilience to stress, while persistently low HRV may indicate stress or fatigue."</p>
      <cite>— Harvard Health Publishing</cite>
    </div>

    <div class="section-divider"></div>

    <!-- ── SpO2 ── -->
    <div class="section-header">
      <div class="section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
        </svg>
        Blood Oxygen — SpO₂
      </div>
    </div>

    <div class="metric-row">
      <div class="card metric-card">
        <div class="metric-label">Saturation</div>
        <div class="metric-value" id="spo2">--</div>
        <div class="metric-unit">percentage (%)</div>
        <div class="metric-status normal" id="spo2Status">
          <span class="dot"></span> Awaiting data
        </div>
      </div>
      <div class="card chart-card">
        <div class="chart-label">Saturation waveform</div>
        <canvas id="spo2Chart" height="140"></canvas>
      </div>
    </div>

    <div class="stat-boxes">
      <div class="stat-box"><div class="stat-val">100%</div><div class="stat-key">Maximum</div></div>
      <div class="stat-box"><div class="stat-val">95%</div><div class="stat-key">Average</div></div>
      <div class="stat-box"><div class="stat-val">90%</div><div class="stat-key">Minimum</div></div>
    </div>

    <div class="quote-strip">
      <p>"A normal, healthy oxygen saturation level is 95–100%. Contact a doctor if your reading consistently drops below 92–94%."</p>
      <cite>— Harvard Health Publishing</cite>
    </div>

  </main>
</div>

<script>
// ── Clock & Greeting ──
function updateClock() {
  const now = new Date();
  const h = now.getHours();
  document.getElementById('clockBadge').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  document.getElementById('greetTime').textContent = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
}
updateClock(); setInterval(updateClock, 1000);

// ── User name ──
const storedName = localStorage.getItem('storedName');
if (storedName) document.getElementById('userName').textContent = storedName.split(' ')[0];

// ── Bluetooth ──
let bluetoothDevice, espCharacteristic;
const SERVICE_UUID = "12345678-1234-1234-1234-123456789abc";
const CHARACTERISTIC_UUID = "abcd1234-ab12-cd34-ef56-123456789abc";

async function connectDevice() {
  try {
    bluetoothDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
    const server = await bluetoothDevice.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    espCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
    await espCharacteristic.startNotifications();
    espCharacteristic.addEventListener('characteristicvaluechanged', handleData);
    const btn = document.getElementById('connectBtn');
    btn.classList.add('connected');
    btn.querySelector('span:not(.conn-dot)') && (btn.childNodes[2].textContent = ' Connected');
  } catch (error) {
    console.error(error);
    alert("Bluetooth connection failed. Ensure your device is nearby and try again.");
  }
}

let rrIntervals = [];

function handleData(event) {
    const decoder = new TextDecoder();
    const rawData = decoder.decode(event.target.value).trim();

    console.log("Raw BLE Data:", rawData);

    try {
        const parsed = JSON.parse(rawData);

        const heartRate = Number(parsed.hr);
        const spo2Value = Number(parsed.spo2);

        if (isNaN(heartRate) || isNaN(spo2Value)) {
            console.error("Invalid values received");
            return;
        }

        document.getElementById("heartRate").innerText = heartRate;
        document.getElementById("spo2").innerText = spo2Value;

        checkAlerts(heartRate, spo2Value);
        drawECGWave();
        drawSpO2Wave();

        saveToHistory(heartRate, spo2Value);

    } catch (e) {
        console.error("JSON Parse Error:", e);
    }
}


// ── Canvas setup ──
function setupCanvas(id) {
  const c = document.getElementById(id);
  c.width = c.parentElement.offsetWidth - 40;
  c.height = 140;
  return c;
}

const heartCanvas = setupCanvas('heartChart');
const spo2Canvas  = setupCanvas('spo2Chart');
const hrvCanvas   = setupCanvas('hrvChart');
const heartCtx    = heartCanvas.getContext('2d');
const spo2Ctx     = spo2Canvas.getContext('2d');
const hrvCtx      = hrvCanvas.getContext('2d');

function clearCanvas(ctx, c) {
  ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, c.width, c.height);
}

function drawECGWave() {
  clearCanvas(heartCtx, heartCanvas);
  heartCtx.strokeStyle = '#123a6b'; heartCtx.lineWidth = 1.8; heartCtx.beginPath();
  for (let i = 0; i < heartCanvas.width; i++) {
    let y = 70;
    const m = i % 120;
    if (m < 5) y = 70; else if (m < 15) y = 42; else if (m < 20) y = 105;
    else if (m < 25) y = 20; else if (m < 30) y = 100; else if (m < 45) y = 62; else y = 70;
    i === 0 ? heartCtx.moveTo(i, y) : heartCtx.lineTo(i, y);
  }
  heartCtx.stroke();
}

function drawSpO2Wave() {
  clearCanvas(spo2Ctx, spo2Canvas);
  spo2Ctx.strokeStyle = '#1a5fa8'; spo2Ctx.lineWidth = 1.8; spo2Ctx.beginPath();
  for (let i = 0; i < spo2Canvas.width; i++) {
    const y = 70 + 28 * Math.sin(i * 0.05);
    i === 0 ? spo2Ctx.moveTo(i, y) : spo2Ctx.lineTo(i, y);
  }
  spo2Ctx.stroke();
}

function drawHRVWave(value) {
  clearCanvas(hrvCtx, hrvCanvas);
  hrvCtx.strokeStyle = '#3b8fd4'; hrvCtx.lineWidth = 1.8; hrvCtx.beginPath();
  for (let i = 0; i < hrvCanvas.width; i++) {
    const y = 70 + (value / 5) * Math.sin(i * 0.05);
    i === 0 ? hrvCtx.moveTo(i, y) : hrvCtx.lineTo(i, y);
  }
  hrvCtx.stroke();
}

function calculateRMSSD(arr) {
  if (arr.length < 2) return 0;
  let sum = 0;
  for (let i = 1; i < arr.length; i++) { const d = arr[i] - arr[i-1]; sum += d*d; }
  return Math.sqrt(sum / (arr.length - 1));
}

function saveToHistory(hr, sp, hrv) {
  const now = new Date();
  let status = 'Normal';
  if (hr > 120 || sp < 90 || hrv < 25) status = 'High Risk';
  else if (hr < 50 || sp < 95 || hrv < 35) status = 'Low';
  const record = { date: now.toLocaleDateString(), time: now.toLocaleTimeString(), heartRate: hr, spo2: sp, hrv: hrv.toFixed(1), status };
  let history = JSON.parse(localStorage.getItem('healthHistory')) || [];
  history.push(record);
  localStorage.setItem('healthHistory', JSON.stringify(history));
}

function showhistory() { window.location.href = 'historyclaude.html'; }
function showhome()    { window.location.href = 'homepageclaude.html'; }
function showprofile() { window.location.href = 'profileclaude.html'; }

// Initial placeholder waves
drawECGWave(); drawSpO2Wave(); drawHRVWave(40);

// Handle resize
window.addEventListener('resize', () => {
  [heartCanvas, spo2Canvas, hrvCanvas].forEach(c => {
    c.width = c.parentElement.offsetWidth - 40;
    c.height = 140;
  });
  drawECGWave(); drawSpO2Wave(); drawHRVWave(40);
});
</script>

</body>
</html>     